---
title: "FV-Raw-Spirit-Data-Wrangle"
author: "Tim van der Stap"
date: "2023-07-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(lubridate)
library(obistools)

```

When downloading the file from the GitHub repo, make sure that you select the correct version.

```{r data download, include=FALSE}
download.file("https://github.com/international-year-of-the-salmon/2022-raw-spirit-data-template/blob/main/original_data/IYS2022_Data_template_RS.xlsx", here::here("IYS_data_template", "IYS2022_Data_template_RS.xlsx"), quiet = TRUE, mode = "wb")

```

Create function to determine polygon coordinates required for the metadata:

```{r polygon coordinates, include = FALSE}

polygon_coords <- function(event){
  event <- event %>% select(latitude_start_decdeg, longitude_start_decdeg) %>% 
    drop_na(latitude_start_decdeg, longitude_start_decdeg) 
  ch <- chull(event)
  coords <- event[c(ch, ch[1]), ]
  coords <- paste(coords$latitude_start_decdeg, coords$longitude_start_decdeg, sep = ",", collapse = " ")
  coords
}

```

Create Event Core:

```{r event, include = FALSE}

event <- read_excel(here::here("IYS_data_template", "IYS2022_Data_template_RS.xlsx"), sheet = "4. SAMPLING EVENT INFO")

event <- event %>% filter(event_type == "Trawl") %>%
  mutate(eventDate = paste0(as_date(
    paste0(year, "-", month, "-", day))))

obistools::check_eventdate(event)

RS_event <- event %>%
  select(eventID = station_event_ID,
         eventDate,
         year, month, day,
         decimalLatitude = latitude_start_decdeg,
         decimalLongitude = longitude_start_decdeg) %>%
  mutate(minimumDepthInMeters = 0,
         maximumDepthInMeters = 8) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(geodeticDatum = "WGS84",
         datasetID = " ",
         bibliographicCitation = " ",
         language = "en",
         modified = lubridate::today(),
         license = "https://creativecommons.org/licenses/by/4.0/legalcode")

# Save locally:
write_csv(RS_event, here("standardized_data", "RS2022_event.csv"))
```

Next, create the occurrence extension:

```{r occurrence}
occurrence <- read_excel(here::here("IYS_data_template", "IYS2022_Data_template_RS.xlsx"), sheet = "5. CATCH FINAL INFO")
  
occurrence <- occurrence %>%
    rename(occurrenceID = catch_ID,
           verbatimIdentification = species_recorded,
           scientificName = scientific_name)
  
unique_spp <- unique(occurrence$scientificName) %>% as.data.frame()
colnames(unique_spp) <- "scientificName"
  
  # Confirm that the total catches across species matches the values reported in the paper.
occurrence %>% group_by(scientificName) %>%
    summarise(total_catch = sum(catch_count))
  
  # Assign WoRMS LSID to the unique species:
worms_id <- worrms::wm_records_names(unique(occurrence$scientificName), marine_only = T) %>% 
    dplyr::bind_rows() %>%
    rename(scientificName = scientificname)
  
  # Now that all unique entries have a WoRMS ID, connect this to the original data frame:
rs_occurrence <- left_join(occurrence, worms_id, by = "scientificName")
  
  # Omit biomass data from the occurrence extension:
rs_occurrence <- rs_occurrence %>%
    mutate(specificEpithet = stringr::word(scientificName, 2)) %>%
    select(eventID = station_event_ID,
           occurrenceID,
           scientificName,
           verbatimIdentification,
           scientificNameID = `lsid`, 
           scientificNameAuthorship = authority,
           taxonomicStatus = status,
           taxonRank = rank, 
           individualCount = catch_count, kingdom, phylum, 
           class, order, family, genus, specificEpithet) %>% 
    distinct() %>%
    mutate(basisOfRecord = "HumanObservation",
           occurrenceStatus = "present")
  
# Save locally:
write_csv(rs_occurrence, here("standardized_data", "RS2022_occurrence.csv"))
```

Finally, create an eMOF extension for the water temperatures associated with the catches.

```{r emof}

rs_temp <- read_excel(here::here("IYS_data_template", "IYS2022_Data_template_RS.xlsx"), sheet = "8. CTD INFO")

# Replace CTD in the station_event_ID with Trawl so that it becomes nested under the correct eventID:
rs_temp$station_event_ID <- gsub("CTD", "Trawl", rs_temp$station_event_ID)

rs_temp <- rs_temp %>%
  select(eventID = station_event_ID,
         sampling_depth_meters,
         sea_water_temperature) %>%
  na.omit()

rs_temp <- rs_temp %>%
  mutate(sea_surface_temperature = ifelse(sampling_depth_meters == 0, sea_water_temperature, NA),
         sea_water_temperature_1m = ifelse(sampling_depth_meters == 1, sea_water_temperature, NA))

rs_temp <- rs_temp %>%
  select(eventID, sea_surface_temperature, sea_water_temperature_1m) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = c(sea_surface_temperature:sea_water_temperature_1m),
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  na.omit() %>%
  mutate(measurementID = paste(eventID, measurementType, sep = "-"),
         measurementTypeID = case_when(
           measurementType == "sea_surface_temperature" ~ "http://vocab.nerc.ac.uk/collection/P07/current/CFSN0381/",
           measurementType == "sea_water_temperature_1m" ~ "http://vocab.nerc.ac.uk/collection/P01/current/TEMPST01/"),
         measurementUnit = "degrees celsius",
         measurementUnitID = "https://vocab.nerc.ac.uk/collection/P06/current/UPAA/",
         measurementValueID = NA) %>%
  select(eventID, measurementID, measurementType, measurementTypeID, measurementValue, measurementValueID,
         measurementUnit, measurementUnitID)

#TODO: Add information from CTD / Vessel if we have more detailed information.
# Data table for the overall catch:

# Save locally:
write_csv(rs_temp, here("standardized_data", "RS2022_emof.csv"))

```


